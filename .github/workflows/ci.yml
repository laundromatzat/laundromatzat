name: CI

on:
  push:
    branches:
      - main

  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write  # For commenting on commits

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
      - name: Install dependencies
        run: npm install
      
      - name: Lint
        id: lint
        continue-on-error: true
        run: |
          npm run lint 2>&1 | tee lint-output.txt
          exit ${PIPESTATUS[0]}
      
      - name: Build
        id: build
        continue-on-error: true
        run: npm run build
        env:
          # Required for the AI assistant to work in the built static site.
          # Set this secret in your repository settings.
          VITE_GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      
      - name: Comment on commit with errors
        if: steps.lint.outcome == 'failure' || steps.build.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let errorMessage = '## ‚ùå CI Build Failed\n\n';
            
            if ('${{ steps.lint.outcome }}' === 'failure') {
              errorMessage += '### Lint Errors\n\n';
              try {
                const lintOutput = fs.readFileSync('lint-output.txt', 'utf8');
                errorMessage += '```\n' + lintOutput + '\n```\n\n';
              } catch (e) {
                errorMessage += '_Error reading lint output_\n\n';
              }
            }
            
            if ('${{ steps.build.outcome }}' === 'failure') {
              errorMessage += '### Build Failed\n\n';
              errorMessage += 'The build step failed. Check the workflow logs for details.\n\n';
            }
            
            errorMessage += '---\n';
            errorMessage += '**For AI Agents**: Use this error output to fix the issues automatically.\n';
            errorMessage += `**Workflow Run**: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: errorMessage
            });
      
      - name: Fail workflow if errors occurred
        if: steps.lint.outcome == 'failure' || steps.build.outcome == 'failure'
        run: exit 1
      
      - name: Upload production build artifact
        if: steps.build.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: dist
          if-no-files-found: error
