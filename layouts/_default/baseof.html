<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">

    <script src="https://unpkg.com/htmx.org@1.9.10" integrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLSi8nO7UC" crossorigin="anonymous"></script>

    <script>
      // --- Core Initializer ---
      function initializePageContent() {
        updateActiveNavButton(); // Always update nav
        initImageGridMasonry(); // Try initializing Masonry for image grids
        initCinemagraphInteractions(); // Try initializing cinemagraph interactions
        // Add other initializers if needed (e.g., for video page specific controls)
      }

      // --- Event Listeners ---
      document.addEventListener('DOMContentLoaded', initializePageContent);
      document.addEventListener('htmx:afterSwap', function(event) {
        // Re-initialize dynamic content after HTMX swaps
        initializePageContent();
      });

      // Ensure the HX-Request header is always sent by HTMX
      document.addEventListener('htmx:configRequest', function(event) {
        event.detail.headers['HX-Request'] = 'true';
      });

      // --- Navigation ---
      function updateActiveNavButton() {
        document.querySelectorAll('.nav-button').forEach(function(button) {
          button.classList.remove('active');
        });
        const currentPath = window.location.pathname;
        let targetButton = null;
        // Handle root path
        if (currentPath === '/' || currentPath === '/index.html' || currentPath === '') {
          targetButton = document.querySelector('.nav-button[hx-get="/"]');
        } else {
          // Match base paths like /videos/, /cinemagraphs/, /images/
           const sections = ['/videos', '/cinemagraphs', '/images'];
           for (const section of sections) {
               // Check if the current path starts with the section path
               // Ensure trailing slash consistency if necessary
               if (currentPath.startsWith(section + '/') || currentPath === section) {
                 targetButton = document.querySelector(`.nav-button[hx-get="${section}"]`);
                 break;
               }
           }
        }
        if (targetButton) {
          targetButton.classList.add('active');
        }
      }

      // --- Masonry for Image Grid ---
      function initImageGridMasonry() {
        const imageGrids = document.querySelectorAll('.image-grid'); // Target ONLY image grid
        if (!imageGrids.length) return; // Exit if no image grids

        // Ensure Masonry and imagesLoaded scripts are loaded
        if (typeof Masonry !== 'undefined' && typeof imagesLoaded !== 'undefined') {
          imageGrids.forEach(grid => {
            imagesLoaded(grid, function() {
              new Masonry(grid, {
                itemSelector: '.image-item', // Use the correct item selector
                percentPosition: true,
                // Consider adding gutter if needed: gutter: 15
              });
            });
          });
        } else {
          console.warn('Masonry or imagesLoaded script not found.');
        }
      }

      // --- Cinemagraph Interactions ---
      function initCinemagraphInteractions() {
        const cinemagraphItems = document.querySelectorAll('.cinemagraph-item');
        if (!cinemagraphItems.length) return; // Exit if no cinemagraphs

        cinemagraphItems.forEach(item => {
          const video = item.querySelector('video');
          if (!video) return;

          // Play on Hover
          item.addEventListener('mouseenter', () => {
             // Play might be interrupted by browser policy if user hasn't interacted
             video.play().catch(e => console.log("Autoplay prevented:", e));
          });
          item.addEventListener('mouseleave', () => {
            video.pause();
            video.currentTime = 0; // Optional: Reset video to start
          });

          // Fullscreen on Click
          item.addEventListener('click', () => {
            if (video.requestFullscreen) {
              video.requestFullscreen();
            } else if (video.webkitRequestFullscreen) { /* Safari */
              video.webkitRequestFullscreen();
            } else if (video.msRequestFullscreen) { /* IE11 */
              video.msRequestFullscreen();
            }
          });

          // Set aspect ratio class based on video metadata (if needed)
           video.addEventListener('loadedmetadata', () => {
               if (video.videoWidth && video.videoHeight) {
                   if (video.videoHeight > video.videoWidth) {
                       item.classList.add('portrait');
                   } else {
                       item.classList.add('landscape'); // Add landscape class if needed
                   }
               }
           });

        });
      }

     // --- (Optional) Video Page Specific Controls ---
     // function initVideoPageControls() {
     //   const videoGridItems = document.querySelectorAll('.video-grid .video-grid__item video');
     //   if (!videoGridItems.length) return;
     //   // Add any specific JS needed ONLY for the main video page here
     //   // Currently, the 'controls' attribute handles basic playback.
     // }


    </script>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="{{ .Site.Params.description | default "Stephen Matzat's Portfolio" }}">
    <title>{{ if .Title }}{{ .Title }} &middot; {{ end }}{{ .Site.Title | default "laundromatzat.com" }}</title>

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

    {{/* Load Masonry/imagesLoaded ONLY if needed (e.g., for image grid) */}}
    {{ if eq .RelPermalink "/images/" }} {{/* Adjust condition based on where Masonry is used */}}
       <script src="https://unpkg.com/imagesloaded@5/imagesloaded.pkgd.min.js"></script>
       <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
    {{ end }}

    {{ $css := resources.Get "css/main.css" | resources.Minify | resources.Fingerprint }}
    <link rel="stylesheet" href="{{ $css.RelPermalink }}" integrity="{{ $css.Data.Integrity }}">

    {{ template "_internal/opengraph.html" . }}
    {{ template "_internal/schema.html" . }}
    {{ template "_internal/twitter_cards.html" . }}

  </head>
  <body>
    <header class="site-header">
      {{/* Removed extra header-container div */}}
      <nav class="site-nav">
        <div class="nav-content">
           <a href="/" class="site-title" hx-get="/" hx-select="#content-container" hx-target="#content-container" hx-push-url="true" hx-indicator="#indicator">
             <img src="/favicon.ico" alt="Favicon" class="favicon-image">laundromatzat.com
           </a>
          <div class="main-nav-container">
            {{/* Using data attributes to help JS identify sections easily */}}
            <a data-nav-section="/" hx-get="/" hx-select="#content-container" hx-target="#content-container" hx-push-url="true" hx-trigger="click" hx-indicator="#indicator" class="nav-button {{ if .IsHome }}active{{ end }}">home</a>
            <a data-nav-section="/videos" hx-get="/videos" hx-select="#content-container" hx-target="#content-container" hx-push-url="true" hx-trigger="click" hx-indicator="#indicator" class="nav-button {{ if eq .Section "videos" }}active{{ end }}">videos</a>
            <a data-nav-section="/cinemagraphs" hx-get="/cinemagraphs" hx-select="#content-container" hx-target="#content-container" hx-push-url="true" hx-trigger="click" hx-indicator="#indicator" class="nav-button {{ if eq .Section "cinemagraphs" }}active{{ end }}">cinemagraphs</a>
            <a data-nav-section="/images" hx-get="/images" hx-select="#content-container" hx-target="#content-container" hx-push-url="true" hx-trigger="click" hx-indicator="#indicator" class="nav-button {{ if eq .Section "images" }}active{{ end }}">images</a>
            <span class="htmx-indicator" id="indicator" style="margin-left: 10px; color: var(--accent);">Loading...</span>
          </div>
        </div>
      </nav>
    </header>

    <main class="content-area">
      <div id="content-container">
        {{/* The main content block is rendered here */}}
        {{ block "main" . }}{{ end }}
      </div>
    </main>

    <footer>
       {{/* Removed extra header-container div */}}
       <p>&copy; {{ now.Format "2006" }} {{ .Site.Title | default "laundromatzat.com" }}</p>
    </footer>
  </body>
</html>