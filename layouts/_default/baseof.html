<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">

    <script src="https://unpkg.com/htmx.org@1.9.10" integrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLSi8nO7UC" crossorigin="anonymous"></script>



    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="{{ .Site.Params.description | default "Stephen Matzat's Portfolio" }}">
    <title>{{ if .Title }}{{ .Title }} &middot; {{ end }}{{ .Site.Title | default "laundromatzat.com" }}</title>

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

    {{ $needsMasonry := false }}
    {{ if eq .RelPermalink "/images/" }} {{/* Condition to load Masonry only on images page */}}
      {{ $needsMasonry = true }}
      <script src="https://unpkg.com/imagesloaded@5/imagesloaded.pkgd.min.js" defer></script>
      <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js" defer></script>
    {{ end }}

    {{/* --- MODIFIED CSS Pipeline (using Concat) --- */}}
    {{ $cssOptions := (dict "targetPath" "css/main.css" "enableSourceMap" true ) }}
    {{/* Find all CSS files in assets/css, concatenate them, process, minify, fingerprint */}}
    {{ $styles := resources.Match "css/**.css" | resources.Concat "css/main.css" | resources.Minify | resources.Fingerprint }}
    <link rel="stylesheet" href="{{ $styles.RelPermalink }}" integrity="{{ $styles.Data.Integrity }}">

    {{ template "_internal/opengraph.html" . }}
    {{ template "_internal/schema.html" . }}
    {{ template "_internal/twitter_cards.html" . }}

  </head>
  <body>
    <header class="site-header">
      <nav class="site-nav">
        <div class="nav-content">
           <a href="/" class="site-title" hx-get="/" hx-select="#content-container" hx-target="#content-container" hx-push-url="true" hx-indicator="#indicator">
             <img src="/favicon.ico" alt="" class="favicon-image"> {{/* Alt empty as it's decorative next to text */}}
             laundromatzat.com
           </a>
          <div class="main-nav-container">
            {{/* Using data attributes to help JS identify sections easily */}}
            <a data-nav-section="/" hx-get="/" hx-select="#content-container" hx-target="#content-container" hx-push-url="true" hx-trigger="click" hx-indicator="#indicator" class="nav-button {{ if .IsHome }}active{{ end }}">home</a>
            <a data-nav-section="/videos" hx-get="/videos" hx-select="#content-container" hx-target="#content-container" hx-push-url="true" hx-trigger="click" hx-indicator="#indicator" class="nav-button {{ if eq .Section "videos" }}active{{ end }}">videos</a>
            <a data-nav-section="/cinemagraphs" hx-get="/cinemagraphs" hx-select="#content-container" hx-target="#content-container" hx-push-url="true" hx-trigger="click" hx-indicator="#indicator" class="nav-button {{ if eq .Section "cinemagraphs" }}active{{ end }}">cinemagraphs</a>
            <a data-nav-section="/images" hx-get="/images" hx-select="#content-container" hx-target="#content-container" hx-push-url="true" hx-trigger="click" hx-indicator="#indicator" class="nav-button {{ if eq .Section "images" }}active{{ end }}">images</a>
            <span class="htmx-indicator" id="indicator">Loading...</span>
          </div>
        </div>
      </nav>
    </header>

    <main class="content-area">
      <div id="content-container">
        {{/* The main content block is rendered here */}}
        {{ block "main" . }}{{ end }}
      </div>
    </main>

    <footer>
       <p>&copy; {{ now.Format "2006" }} {{ .Site.Title | default "laundromatzat.com" }}</p>
    </footer>
{{/* layouts/_default/baseof.html - End of body */}}
    {{/* ... (footer tag above this) ... */}}

    {{/* --- Load External Javascript --- */}}
    {{/* Process main.js with Hugo Pipes for fingerprinting/minification */}}
    {{ $mainJS := resources.Get "js/main.js" | js.Build (dict "minify" true) | fingerprint }}
    {{ if $mainJS }}
      <script src="{{ $mainJS.RelPermalink }}" integrity="{{ $mainJS.Data.Integrity }}" defer></script>
    {{ else }}
      {{/* Fallback or warning if js/main.js is not found */}}
      <script>console.error("main.js not found in assets/js/");</script>
    {{ end }}

    {{/* --- Load Masonry/ImagesLoaded IF needed (e.g., on images page) --- */}}
    {{ if eq .RelPermalink "/images/" }} {{/* Condition based on your setup */}}
      <script src="https://unpkg.com/imagesloaded@5/imagesloaded.pkgd.min.js" defer></script>
      <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js" defer></script>
    {{ end }}

    {{/* --- Inline Script for Initialization & HTMX Hooks --- */}}
    <script>
      // Ensure functions from main.js are called after DOM is ready and after HTMX swaps
      document.addEventListener('DOMContentLoaded', () => {
          if (typeof initializePageContent === 'function') {
              initializePageContent();
          } else {
              console.error('initializePageContent function not found. Check main.js loading.');
          }
      });

      document.addEventListener('htmx:afterSwap', (event) => {
        console.log("HTMX swap finished, re-initializing content..."); // Debug log
        if (typeof initializePageContent === 'function') {
            // Use a small delay to ensure DOM is fully settled after swap, especially for Masonry
            setTimeout(initializePageContent, 50);
        } else {
            console.error('initializePageContent function not found after HTMX swap.');
        }
      });

      // Ensure the HX-Request header is always sent by HTMX
      document.addEventListener('htmx:configRequest', (event) => {
        event.detail.headers['HX-Request'] = 'true';
      });
    </script>

  </body>
</html>