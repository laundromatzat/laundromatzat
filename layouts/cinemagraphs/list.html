{{ define "main" }}
<div class="section-header">
  <h1>Cinemagraphs</h1>
  <div class="accent-line"></div>
</div>
<div class="masonry-grid" id="cinemagraph-grid">
  {{ range $item := $.Site.Data.cinemagraphs.cinemagraphs }}
  <div class="masonry-item{{ if eq $item.id "fireside-meditation-cinemagraph" }} portrait{{ else }}{{ end }}">
    <div class="cinemagraph-container">
      <video loop muted preload="metadata" class="cinemagraph-video" poster="{{ if .thumbnail }}{{ .thumbnail }}{{ end }}">
        <source src="{{ .token }}" type="video/mp4">
        Your browser does not support the video tag.
      </video>
      <div class="cinemagraph-overlay">
        <div class="cinemagraph-metadata">
          <h2>{{ .title }}</h2>
          <div class="cinemagraph-details">
            {{ if .location }}
            <p class="location">
              <i class="location-icon"></i>{{ .location }}
            </p>
            {{ end }}
            {{ if .date }}
            <p class="date">
              <i class="calendar-icon"></i>{{ .date }}
            </p>
            {{ end }}
          </div>
        </div>
      </div>
    </div>
  </div>
  {{ end }}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const cinemagraphs = document.querySelectorAll('.masonry-item');

  // Handle hover effects
  cinemagraphs.forEach(item => {
    const video = item.querySelector('video');

    // Play on hover
    item.addEventListener('mouseenter', function() {
      if (video.paused) {
        video.play();
      }
    });

    // Pause when not hovering
    item.addEventListener('mouseleave', function() {
      if (!video.paused) {
        video.pause();
      }
    });

    // Full screen on click
    item.addEventListener('click', function() {
      if (video.requestFullscreen) {
        video.play(); // Ensure it's playing when fullscreen
        video.requestFullscreen();
      } else if (video.webkitRequestFullscreen) {
        video.play();
        video.webkitRequestFullscreen();
      } else if (video.msRequestFullscreen) {
        video.play();
        video.msRequestFullscreen();
      }
    });

    // Continue playing in fullscreen
    video.addEventListener('fullscreenchange', function() {
      if (document.fullscreenElement === video) {
        video.loop = true;
        video.muted = false; // Optional: unmute in fullscreen
        video.play();
      } else {
        video.muted = true;
        if (!item.matches(':hover')) {
          video.pause();
        }
      }
    });

    // Handle aspect ratio detection
    video.addEventListener('loadedmetadata', function() {
      // Check if video is portrait or landscape
      if (video.videoHeight > video.videoWidth) {
        item.classList.add('portrait');
      } else {
        item.classList.add('landscape');
      }
    });

    // Pause cinemagraphs when not visible
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        const video = entry.target.querySelector('video');
        if (!video) return;

        if (entry.isIntersecting) {
          // Only play on hover, not automatically when visible
          if (entry.target.classList.contains('hovered')) {
            video.play().catch(e => console.error("Video play error:", e));
          }
        } else {
          video.pause();
        }
      });
    }, { threshold: 0.5 });

    cinemagraphs.forEach(item => {
      observer.observe(item);

      // Play on hover
      item.addEventListener('mouseenter', () => {
        const video = item.querySelector('video');
        if (video) {
          item.classList.add('hovered');
          video.play().catch(e => console.error("Video play error:", e));
        }
      });

      // Pause when not hovered
      item.addEventListener('mouseleave', () => {
        const video = item.querySelector('video');
        if (video) {
          item.classList.remove('hovered');
          video.pause();
        }
      });

      // Fullscreen on click
      item.addEventListener('click', () => {
        const video = item.querySelector('video');
        if (video && video.requestFullscreen) {
          video.requestFullscreen().catch(e => console.error("Fullscreen error:", e));
          video.play().catch(e => console.error("Video play error:", e));
        }
      });
    });
  });
});
</script>
{{ end }}